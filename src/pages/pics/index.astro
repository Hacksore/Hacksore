---
import Layout from "../../layouts/layout.astro";
import { PicsGallery } from "../../components/pics-gallery";
import { listR2Images } from "../../utils/s3";

// Get configuration from environment variables
const bucketName = import.meta.env.R2_BUCKET_NAME;
const prefix = import.meta.env.R2_PREFIX || "";

const r2Config = {
  endpoint: import.meta.env.R2_ENDPOINT,
  accountId: import.meta.env.R2_ACCOUNT_ID,
  accessKeyId: import.meta.env.R2_ACCESS_KEY_ID,
  secretAccessKey: import.meta.env.R2_SECRET_ACCESS_KEY,
  publicUrl: import.meta.env.R2_PUBLIC_URL,
  usePresignedUrls: import.meta.env.R2_USE_PRESIGNED_URLS === "true",
};

let images: Array<{
  key: string;
  url: string;
  lastModified?: Date;
  size?: number;
}> = [];

let error: string | null = null;

if (!bucketName) {
  error = "R2_BUCKET_NAME environment variable is not set";
} else {
  try {
    images = await listR2Images(bucketName, prefix, r2Config);
  } catch (err) {
    error = err instanceof Error ? err.message : "Failed to fetch images from R2";
    console.error("Error fetching images:", err);
  }
}

// Set cache headers for Vercel edge caching
// Cache for 10 minutes (600 seconds) - adjust as needed
// This prevents making R2 API calls on every request
Astro.response.headers.set("Cache-Control", "public, s-maxage=600, stale-while-revalidate=86400");
---

<Layout title="Pics - Sean Boult" description="Some of the best tiktok reactions pics">
	<section class="prose prose-invert px-4 md:px-0">
		<h1 class="text-4xl font-bold mb-8">Pics</h1>
		<p class="mb-6">Some of the best reactions pics</p>
		<PicsGallery client:load images={images} />
	</section>
</Layout>

